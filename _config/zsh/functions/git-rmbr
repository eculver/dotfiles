#!/bin/zsh

set -euo pipefail

protected_branches=(
  main
  master
  develop
  dev
)

current_branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || true)"
if [[ -z "${current_branch}" || "${current_branch}" == "HEAD" ]]; then
  echo "Not on a branch (detached HEAD). Aborting." >&2
  exit 1
fi

for protected in "${protected_branches[@]}"; do
  if [[ "${current_branch}" == "${protected}" ]]; then
    echo "Refusing to delete protected branch: ${current_branch}" >&2
    exit 1
  fi
done

read -r "reply?Delete branch '${current_branch}'? [y/N] "
if [[ ! "${reply}" =~ ^[Yy]$ ]]; then
  echo "Aborted."
  exit 0
fi

if ! git show-ref --verify --quiet refs/heads/main; then
  echo "Branch 'main' does not exist locally. Aborting." >&2
  exit 1
fi

git checkout main
git pull --ff-only
git branch -d "${current_branch}"
